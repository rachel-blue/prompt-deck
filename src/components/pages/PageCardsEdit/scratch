import '../../../tests/firebase-mocks';
import '../../../tests/router-mocks';
import React from 'react';
import { mount } from 'enzyme';
import ReactRouter from 'react-router';
import firebase from '../../../firebase/firebase';
import PageCardsEdit from './PageCardsEdit';
import { findByTestAttr } from '../../../tests/testUtils';
import { cardMock } from '../../../utils/mocks';


describe('Page Cards Edit', () => {
  const setup = async () => {
    const wrapper = await mount(
      <PageCardsEdit />,
    );

    return {
      wrapper,
    };
  };

  it('renders without error', async () => {
    const { wrapper } = await setup();

    const component = findByTestAttr(wrapper, 'page-cards-edit');

    expect(component.length).toBe(1);
  });

  describe('firebase collection get cards', () => {
    it('should call the collection with the expected arguments', async () => {
      const spyCollection = firebase.db.collection;

      await setup();

      expect(spyCollection).toBeCalledWith('cards');
    });

    it('should call the doc with the expected arguments', async () => {
      const id = 'abc';

      jest.spyOn(ReactRouter, 'useParams')
        .mockImplementation(() => { return { id }; });

      const spyDoc = jest.fn();
      spyDoc.mockReturnValue({});

      const spyCollection = jest.spyOn(firebase.db, 'collection');
      spyCollection.mockReturnValue({
        doc: spyDoc,
      });

      await setup();

      expect(spyDoc).toBeCalledWith(id);
    });

    it('should call the doc with the expected arguments', async () => {
      const id = 'abc';

      jest.spyOn(ReactRouter, 'useParams')
        .mockImplementation(() => { return { id }; });

      const spyDoc = jest.fn();
      spyDoc.mockReturnValue({});

      const spyCollection = jest.spyOn(firebase.db, 'collection');
      spyCollection.mockReturnValue({
        doc: spyDoc,
      });

      await setup();

      expect(spyDoc).toBeCalledWith(id);
    });

    it('should display the returned card', async () => {
      const cardData = cardMock();

      const { wrapper } = await setup();
      wrapper.update();
      const cardEl = findByTestAttr(wrapper, 'page-cards-edit__card');

      expect(cardEl.length).toBe(1);
    });

    fit('should not display the card by default', async () => {
      const { wrapper } = await setup();
      wrapper.update();
      const cardEl = findByTestAttr(wrapper, 'page-cards-edit__card');

      expect(cardEl.length).toBe(0);
    });
  });

  describe('Displaying Card Props', () => {
    it('should show the card title', async () => {
      const title = 'Epic Things';
      const card = [cardMock()];
      card[0].cardTitle = title;

      const { wrapper } = await setup({ card });
      wrapper.update();
      const cardTitle = findByTestAttr(wrapper, 'page-cards-edit__title');

      expect(cardTitle.text()).toBe(title);
    });
  });
});
